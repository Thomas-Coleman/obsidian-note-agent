#!/bin/bash
# Production Docker Compose management script
# Usage: bin/production [command]

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Check if .env.production exists
if [ ! -f .env.production ]; then
  echo -e "${RED}Error: .env.production file not found!${NC}"
  echo "Please copy .env.production.example to .env.production and configure it."
  exit 1
fi

# Validate required environment variables by reading .env.production directly
validate_env() {
  local missing=0

  # Check if ANTHROPIC_API_KEY looks configured
  if grep -q "^ANTHROPIC_API_KEY=your_anthropic_api_key_here" .env.production; then
    echo -e "${YELLOW}Warning: ANTHROPIC_API_KEY not configured in .env.production${NC}"
    missing=1
  fi

  # Check if OBSIDIAN_VAULT_PATH looks configured
  if grep -q "^OBSIDIAN_VAULT_PATH=/path/to/your/obsidian/vault" .env.production; then
    echo -e "${YELLOW}Warning: OBSIDIAN_VAULT_PATH not configured in .env.production${NC}"
    missing=1
  fi

  if [ $missing -eq 1 ]; then
    echo -e "${RED}Please update .env.production with your actual values${NC}"
    exit 1
  fi
}

# Command handling
case "${1:-help}" in
  start)
    echo -e "${GREEN}Starting production environment...${NC}"
    validate_env
    docker-compose --env-file .env.production up -d
    echo -e "${GREEN}Production environment started!${NC}"
    echo -e "App available at: http://localhost"
    echo -e "View logs: ${YELLOW}bin/production logs${NC}"
    ;;

  stop)
    echo -e "${YELLOW}Stopping production environment...${NC}"
    docker-compose --env-file .env.production down
    echo -e "${GREEN}Production environment stopped${NC}"
    ;;

  restart)
    echo -e "${YELLOW}Restarting production environment...${NC}"
    docker-compose --env-file .env.production restart
    echo -e "${GREEN}Production environment restarted${NC}"
    ;;

  rebuild)
    echo -e "${YELLOW}Rebuilding and restarting production environment...${NC}"
    validate_env
    docker-compose --env-file .env.production up -d --build
    echo -e "${GREEN}Production environment rebuilt and started${NC}"
    ;;

  logs)
    docker-compose --env-file .env.production logs -f "${2:-app}"
    ;;

  console)
    echo -e "${GREEN}Opening Rails console in production...${NC}"
    docker-compose --env-file .env.production exec app bin/rails console
    ;;

  bash)
    echo -e "${GREEN}Opening bash shell in app container...${NC}"
    docker-compose --env-file .env.production exec app bash
    ;;

  db)
    echo -e "${GREEN}Opening MySQL console...${NC}"
    DB_PASS=$(grep "^MYSQL_ROOT_PASSWORD=" .env.production | cut -d'=' -f2-)
    docker-compose --env-file .env.production exec db mysql -u root -p"${DB_PASS}"
    ;;

  status)
    docker-compose --env-file .env.production ps
    ;;

  clean)
    echo -e "${RED}WARNING: This will remove all containers and volumes (including database data)${NC}"
    read -p "Are you sure? (yes/no): " confirm
    if [ "$confirm" = "yes" ]; then
      docker-compose --env-file .env.production down -v
      echo -e "${GREEN}Cleaned up all containers and volumes${NC}"
    else
      echo -e "${YELLOW}Cancelled${NC}"
    fi
    ;;

  help|*)
    echo "Production Docker Compose Management"
    echo ""
    echo "Usage: bin/production [command]"
    echo ""
    echo "Commands:"
    echo "  start     - Start production environment"
    echo "  stop      - Stop production environment"
    echo "  restart   - Restart production environment"
    echo "  rebuild   - Rebuild Docker image and restart"
    echo "  logs      - Tail application logs (add service name for specific service)"
    echo "  console   - Open Rails console"
    echo "  bash      - Open bash shell in app container"
    echo "  db        - Open MySQL console"
    echo "  status    - Show status of all services"
    echo "  clean     - Remove all containers and volumes (DESTRUCTIVE)"
    echo "  help      - Show this help message"
    echo ""
    echo "Examples:"
    echo "  bin/production start"
    echo "  bin/production logs app"
    echo "  bin/production logs db"
    echo "  bin/production console"
    ;;
esac
